apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: dpc-batch
  annotations:
    workflows.argoproj.io/title: DPC (Differential Phase Contrast)
    workflows.argoproj.io/description: |
      DPC imaging produces an image of the phase shifts to the X-ray beam as a result of interaction with the sample by measuring the gradient of the phase and retrieving the phase shifts by a straightforward integration step.
      Although the resolution of the DPC image is limited by the beam size, the simplicity of the measurement and phase-retrieval step can provide rapid feedback during experiments and produces good representative images of the sample, even with challenging, weakly scattering samples.
      This methodology is described in Quinn et al. 2023 - Journal of Synchrotron Radiation: Volume 30| Part 1| January 2023| Pages 200-207, https://doi.org/10.1107/S1600577522010633
    workflows.diamond.ac.uk/parameter-schema: |
      {{- .Files.Get "schema/dpcSchema.json" | nindent 6 }}
    workflows.diamond.ac.uk/ui-schema: |
      {{- .Files.Get "schema/dpcUISchema.json" | nindent 6 }}
spec:
  entrypoint: dpc-batch
  arguments:
    parameters:
    - name: visitdir
      valueFrom:
        configMapKeyRef:
          name: sessionspaces
          key: data_directory
    - name: outputFolder
      value: /tmp/output
    - name: scanNumbers
      value: "[395329]"
  volumeClaimTemplates:
  - metadata:
      name: tmp
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 20Gi
      storageClassName: netapp
  templates:
  - name: dpc-mount-files
    script:
      image: gitlab.diamond.ac.uk:5050/i14/i14_utility/dpc:v0.1
      command: [bash]
      source: |
        echo '{{ .Files.Get "notebooks/dpc_autoprocess3.ipynb" | b64enc }}' | base64 -d > /tmp/notebook.ipynb
        echo '{{ .Files.Get "configs/processing.yaml" | b64enc }}' | base64 -d > /tmp/config.yaml
      volumeMounts:
      - name: tmp
        mountPath: /tmp
  - name: dpc-notebook
    steps:
    - - name: loop-notebooks
        template: gen-notebook
        arguments:
          parameters:
          - name: outputFolder
            value: "{{`{{ workflow.parameters.outputFolder }}`}}"
          - name: scanNumber
            value: "{{`{{ item }}`}}"
        withParam: "{{`{{ workflow.parameters.scanNumbers }}`}}"
  - name: gen-notebook
    inputs:
      parameters:
      - name: outputFolder
      - name: scanNumber
    script:
      image: gitlab.diamond.ac.uk:5050/i14/i14_utility/dpc:v0.1
      env:
      - name: HOME
        value: /tmp
      command: [bash]
      source: |
        python -m papermill /tmp/notebook.ipynb /tmp/notebook-parametrized.ipynb \
          -p inpath "{{`{{ workflow.parameters.visitdir }}`}}/scan/i14-{{`{{ inputs.parameters.scanNumber }}`}}.nxs" \
          -p process_configfile /tmp/config.yaml \
          -p outpath "{{`{{ inputs.parameters.outputFolder }}`}}/i14-{{`{{ inputs.parameters.scanNumber }}`}}_dpc-phase.nxs" \
          -p auto_processing False
        python -m jupyter nbconvert /tmp/notebook-parametrized.ipynb --to notebook --execute --allow-errors --output dpc-notebook-{{`{{ inputs.parameters.scanNumber }}`}} --output-dir "{{`{{ inputs.parameters.outputFolder }}`}}"
        python -m jupyter nbconvert "{{`{{ inputs.parameters.outputFolder }}`}}/dpc-notebook-{{`{{ inputs.parameters.scanNumber }}`}}.ipynb" --to html --no-input --output dpc-output-{{`{{ inputs.parameters.scanNumber }}`}} --output-dir "{{`{{ inputs.parameters.outputFolder }}`}}"
      volumeMounts:
      - name: session
        mountPath: "{{`{{ workflow.parameters.visitdir }}`}}"
      - name: tmp
        mountPath: /tmp
    outputs:
      artifacts:
      - name: dpc-output
        path: "{{`{{ inputs.parameters.outputFolder }}`}}/dpc-output-{{`{{ inputs.parameters.scanNumber }}`}}.html"
        archive:
          none: {}
    podSpecPatch: |
      containers:
      - name: main
        resources:
          requests:
            cpu: 10
            memory: 30Gi
          limits:
            cpu: 10
            memory: 30Gi
    tolerations:
    - key: nodegroup
      operator: Equal
      value: workflows
      effect: NoSchedule
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
            - key: nodegroup
              operator: In
              values:
              - workflows
    volumes:
    - name: session
      hostPath:
        path: "{{`{{ workflow.parameters.visitdir }}`}}"
        type: Directory
  - name: dpc-batch
    dag:
      tasks:
      - name: files
        template: dpc-mount-files
      - name: notebook
        template: dpc-notebook
        dependencies: [files]
